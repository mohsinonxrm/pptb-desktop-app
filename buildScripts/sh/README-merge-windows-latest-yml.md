# Merge Windows/macOS latest.yml Scripts

## Purpose

These scripts generate properly formatted update metadata files containing both x64 and ARM64 installers for electron-updater auto-update functionality.

Use these when you need to manually fix a GitHub release's update files without re-running the entire build pipeline.

## The Problem They Solve

When Windows/macOS x64 and ARM64 builds upload separate YAML files, only one architecture is included in the final update metadata. This causes electron-updater to only see one architecture, leading to users downloading the wrong installer.

The merged YAML files contain both architectures, allowing electron-updater to automatically select the correct one based on the user's system architecture.

## Prerequisites

- `bash` shell (Linux, macOS, WSL, or Git Bash on Windows)
- `curl` (for downloading from GitHub releases)
- `sha256sum` and `sha512sum` (for hash calculation on Linux)
- `shasum` (for hash calculation on macOS)
- `gh` CLI (optional, for uploading to GitHub)

## Available Scripts

### Windows: `merge-windows-latest-yml.sh`

Generates `latest.yml` for Windows updates (EXE installers).

### macOS: `merge-macos-latest-yml.sh`

Generates `latest-mac.yml` for macOS updates (DMG installers).

## Usage

### Option 1: Download from Existing GitHub Release

Use this to fix an already-published release (like v1.1.3):

**Windows:**
```bash
cd buildScripts
./merge-windows-latest-yml.sh 1.1.3 v1.1.3
gh release upload v1.1.3 latest.yml --clobber
```

**macOS:**
```bash
cd buildScripts
./merge-macos-latest-yml.sh 1.1.3 v1.1.3
gh release upload v1.1.3 latest-mac.yml --clobber
```

This will:
1. Download both x64 and ARM64 installers from the v1.1.3 GitHub release
2. Calculate SHA256/SHA512 hashes
3. Generate a merged YAML file in the current directory

### Option 2: Use Local Build Files

Use this when you have local build artifacts:

**Windows:**
```bash
cd buildScripts
./merge-windows-latest-yml.sh 1.1.3
```

**macOS:**
```bash
cd buildScripts
./merge-macos-latest-yml.sh 1.1.3
```

This will look for installer files in the `build/` directory.

## Output

The scripts create YAML files in the current directory:

**Windows (`latest.yml`):**
```yaml
version: 1.1.3
files:
  - url: Power-Platform-ToolBox-1.1.3-x64-win.exe
    sha512: <calculated-x64-sha512>
    sha256: <calculated-x64-sha256>
    size: 83575696
    blockMapSize: null
  - url: Power-Platform-ToolBox-1.1.3-arm64-win.exe
    sha512: <calculated-arm64-sha512>
    sha256: <calculated-arm64-sha256>
    size: 86587224
    blockMapSize: null
releaseDate: 2026-02-19T10:54:00.000Z
```

**macOS (`latest-mac.yml`):**
```yaml
version: 1.1.3
files:
  - url: Power-Platform-ToolBox-1.1.3-x64-mac.dmg
    sha512: <calculated-x64-sha512>
    sha256: <calculated-x64-sha256>
    size: 110450111
    blockMapSize: null
  - url: Power-Platform-ToolBox-1.1.3-arm64-mac.dmg
    sha512: <calculated-arm64-sha512>
    sha256: <calculated-arm64-sha256>
    size: 103969103
    blockMapSize: null
releaseDate: 2026-02-19T10:54:00.000Z
```

## Uploading to GitHub Release

### Using GitHub CLI

**Windows:**
```bash
gh release upload v1.1.3 latest.yml --clobber
```

**macOS:**
```bash
gh release upload v1.1.3 latest-mac.yml --clobber
```

The `--clobber` flag replaces the existing file.

### Using GitHub Web UI

1. Go to https://github.com/PowerPlatformToolBox/desktop-app/releases/edit/v1.1.3
2. Scroll to the release assets section
3. Delete the existing `latest.yml` or `latest-mac.yml` file
4. Upload the new file generated by the script

## Fixing v1.1.3 Release

To fix the current v1.1.3 release for both platforms:

**Windows:**
```bash
cd buildScripts
./merge-windows-latest-yml.sh 1.1.3 v1.1.3
gh release upload v1.1.3 latest.yml --clobber
```

**macOS:**
```bash
cd buildScripts
./merge-macos-latest-yml.sh 1.1.3 v1.1.3
gh release upload v1.1.3 latest-mac.yml --clobber
```

After uploading, users who check for updates will receive the correct installer for their architecture.

## How It Works

1. **Locates Installers**: Finds or downloads both x64 and ARM64 installers (EXE for Windows, DMG for macOS)
2. **Calculates Hashes**: Computes SHA256 and SHA512 checksums for integrity verification
3. **Generates YAML**: Creates a YAML file with both file entries
4. **Architecture Detection**: electron-updater automatically selects the correct installer

## Architecture Detection

The electron-updater library automatically detects the user's architecture:

**Windows:**
- On x64 systems: `process.arch === "x64"` → downloads `*-x64-win.exe`
- On ARM64 systems: `process.arch === "arm64"` → downloads `*-arm64-win.exe`

**macOS:**
- On Intel Macs: `process.arch === "x64"` → downloads `*-x64-mac.dmg`
- On Apple Silicon: `process.arch === "arm64"` → downloads `*-arm64-mac.dmg`

This is done by matching the architecture string in the filename.

## Troubleshooting

### "Failed to download x64 installer/DMG"

The release tag or version doesn't exist on GitHub. Check:
- The release tag is correct (e.g., `v1.1.3` not `1.1.3`)
- The release has been published (not a draft)
- The installers have been uploaded to the release

### "Could not find x64 installer/DMG in build/ directory"

When using local files, ensure you've run the build first:

**Windows:**
```bash
pnpm run build
pnpm run package:win       # For x64
pnpm run package:win-arm64 # For ARM64
```

**macOS:**
```bash
pnpm run build
pnpm run package:mac       # Builds both x64 and ARM64
```

### "sha256sum: command not found" (macOS)

On macOS, use `shasum` which is already included. The scripts handle this automatically.

If you get errors, you may need to install coreutils:

```bash
brew install coreutils
```

## Related Files

- `.github/workflows/prod-release.yml` - Production release workflow (automated merge for both Windows and macOS)
- `.github/workflows/nightly-release.yml` - Nightly release workflow (automated merge for both Windows and macOS)

## Future Enhancements

Starting with v1.1.4 and later, the GitHub Actions workflows automatically merge both Windows and macOS YAML files, so manual intervention won't be needed for new releases.
